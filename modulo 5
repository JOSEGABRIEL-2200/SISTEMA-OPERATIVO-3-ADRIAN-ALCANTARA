

## Práctica 1: Sincronización de carpetas con rsync (1 punto)

### Objetivo

- Crear una carpeta en el servidor primario con 100 archivos.
- Sincronizar esa carpeta a un servidor remoto usando `rsync`.
- Automatizar la sincronización con un script y un `crontab` que corra cada 1 minuto.
- Validar creando un archivo nuevo y comprobando que aparece en el servidor secundario.

### 1. Habilitar SSH en ambos servidores

En **kali1** y **kali2**:

```bash
sudo systemctl status ssh
sudo systemctl start ssh
sudo systemctl enable ssh
Ver la IP de cada servidor:

bash
Copiar código
ip a
# o
ifconfig
En el ejemplo, el servidor remoto tiene IP 10.0.0.136.

2. Configurar acceso SSH sin contraseña (desde kali2 hacia kali1)
En kali2:

bash
Copiar código
ssh gabriel@10.0.0.136      # Primera conexión (aceptar la huella)
ssh-keygen                  # Generar clave SSH (ENTER en todas las preguntas)
ssh-copy-id gabriel@10.0.0.136
ssh gabriel@10.0.0.136      # Probar que entra sin pedir password
3. Crear carpeta y 100 archivos en el servidor primario
En este caso, trabajamos desde kali2 como servidor "primario":

bash
Copiar código
cd ~/Desktop
mkdir prueba1
cd prueba1
touch archivo{1..100}.txt
ls
4. Sincronizar carpeta con rsync al servidor remoto
Instalar rsync (si no está instalado):

bash
Copiar código
sudo apt install rsync -y
Ejecutar la sincronización inicial desde kali2 hacia kali1 (10.0.0.136):

bash
Copiar código
rsync -azp /home/gabriel/Desktop/prueba1 gabriel@10.0.0.136:/home/gabriel/prueba1
-a → modo archivo (preserva permisos, etc.)

-z → comprime durante la transferencia

-p → preserva permisos

5. Crear un script para automatizar la sincronización
En kali2:

bash
Copiar código
nano /home/gabriel/prueba_script.sh
Contenido del script:

bash
Copiar código
#!/bin/bash

# Sincroniza la carpeta prueba1 al servidor remoto 10.0.0.136
rsync -azp /home/gabriel/Desktop/prueba1 gabriel@10.0.0.136:/home/gabriel/prueba1
Dar permisos de ejecución:

bash
Copiar código
chmod +x /home/gabriel/prueba_script.sh
Probar el script manualmente:

bash
Copiar código
/home/gabriel/prueba_script.sh
6. Crear un crontab para sincronizar cada minuto
Editar el crontab del usuario:

bash
Copiar código
crontab -e
Agregar la siguiente línea:

cron
Copiar código
* * * * * /home/gabriel/prueba_script.sh
Guardar y salir.

Verificar que se guardó:

bash
Copiar código
crontab -l
7. Prueba de funcionamiento
En kali2 (servidor primario), dentro de la carpeta prueba1:

bash
Copiar código
cd ~/Desktop/prueba1
touch pedro.txt
ls
Esperar un minuto y luego, en kali1 (servidor remoto):

bash
Copiar código
ls /home/gabriel/prueba1
cat /home/gabriel/prueba1/pedro.txt
Si el archivo pedro.txt aparece en el servidor secundario, el crontab y rsync están funcionando correctamente.

Práctica 2: Instalación y configuración del Cluster con IP flotante (2 puntos)
Objetivo
Instalar un sistema de Alta Disponibilidad con Keepalived en dos nodos.

Configurar una IP flotante compartida por ambos.

Comprobar que el ping a la IP flotante se mantiene aunque se reinicien servidores.

Aunque el enunciado menciona Heartbeat o Pacemaker, en esta práctica se utilizó Keepalived (VRRP) para proporcionar la IP flotante.

1. Instalación de Keepalived
En kali1 y kali2:

bash
Copiar código
sudo apt update
sudo apt install -y keepalived
Habilitar el servicio:

bash
Copiar código
sudo systemctl enable keepalived
2. Configuración de Keepalived en kali1 (MASTER)
Editar el archivo de configuración:

bash
Copiar código
sudo nano /etc/keepalived/keepalived.conf
Contenido:

conf
Copiar código
global_defs {
    router_id KALI_SRV1
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0              # Ajustar si tu interfaz es diferente
    virtual_router_id 51        # Debe ser el mismo en ambos nodos
    priority 101                # Mayor prioridad = MASTER
    advert_int 1

    authentication {
        auth_type PASS
        auth_pass secret
    }

    virtual_ipaddress {
        10.0.0.155/24           # IP flotante compartida
    }
}
Reiniciar Keepalived:

bash
Copiar código
sudo systemctl restart keepalived
sudo systemctl status keepalived
Verificar que la IP flotante esté asignada:

bash
Copiar código
ip a show eth0
3. Configuración de Keepalived en kali2 (BACKUP)
bash
Copiar código
sudo nano /etc/keepalived/keepalived.conf
Contenido:

conf
Copiar código
global_defs {
    router_id KALI_SRV2
}

vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 100                # Menor que el MASTER
    advert_int 1

    authentication {
        auth_type PASS
        auth_pass secret
    }

    virtual_ipaddress {
        10.0.0.155/24           # Misma IP flotante
    }
}
Reiniciar Keepalived:

bash
Copiar código
sudo systemctl restart keepalived
sudo systemctl status keepalived
ip a show eth0
4. Pruebas de Alta Disponibilidad de la IP flotante
Desde otro equipo (o uno de los dos, contra la IP flotante):

bash
Copiar código
ping 10.0.0.155
Con kali1 encendido, la IP flotante debe estar en kali1.

Detener Keepalived en kali1:

bash
Copiar código
sudo systemctl stop keepalived
Verificar que la IP flotante pasa a kali2:

bash
Copiar código
ip a show eth0   # en kali2
El ping a 10.0.0.155 no debe cortarse, demostrando la Alta Disponibilidad de la IP flotante.

Práctica 3: Cluster de Alta Disponibilidad HTTP con Keepalived (1 punto)
Objetivo
Configurar dos servidores web con Apache.

Cada servidor muestra una página HTML distinta (Server 1 / Server 2).

Implementar Alta Disponibilidad del servicio HTTP usando Keepalived con un script que monitorea el estado de Apache.

Si Apache se cae en el MASTER, el BACKUP toma la IP flotante y el servicio sigue disponible.

1. Instalar y habilitar Apache en ambos servidores
En kali1 y kali2:

bash
Copiar código
sudo apt install -y apache2
sudo systemctl enable apache2
sudo systemctl start apache2
2. Crear páginas HTML diferenciadas
En kali1:

bash
Copiar código
echo "<h1>Servicio Web Activo en Server 1 (MASTER)</h1>" | sudo tee /var/www/html/index.html
En kali2:

bash
Copiar código
echo "<h1>Servicio Web Activo en Server 2 (BACKUP)</h1>" | sudo tee /var/www/html/index.html
3. Script de chequeo de Apache
En ambos servidores, crear el script:

bash
Copiar código
sudo nano /etc/keepalived/check_apache.sh
Contenido:

bash
Copiar código
#!/bin/bash

if systemctl is-active --quiet apache2; then
    exit 0
else
    exit 1
fi
Dar permisos de ejecución:

bash
Copiar código
sudo chmod +x /etc/keepalived/check_apache.sh
4. Configuración de Keepalived para HA HTTP
En kali1 (MASTER)
bash
Copiar código
sudo nano /etc/keepalived/keepalived.conf
Contenido:

conf
Copiar código
global_defs {
    router_id KALI_SRV1
    script_security nonroot
}

vrrp_script chk_apache {
    script "/etc/keepalived/check_apache.sh"
    interval 3
    weight -50
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 101
    advert_int 1

    authentication {
        auth_type PASS
        auth_pass secret
    }

    track_script {
        chk_apache
    }

    virtual_ipaddress {
        10.0.0.155/24
    }
}
Reiniciar Keepalived:

bash
Copiar código
sudo systemctl restart keepalived
sudo systemctl status keepalived
En kali2 (BACKUP)
bash
Copiar código
sudo nano /etc/keepalived/keepalived.conf
Contenido:

conf
Copiar código
global_defs {
    router_id KALI_SRV2
    script_security nonroot
}

vrrp_script chk_apache {
    script "/etc/keepalived/check_apache.sh"
    interval 3
    weight -50
}

vrrp_instance VI_1 {
    state BACKUP
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1

    authentication {
        auth_type PASS
        auth_pass secret
    }

    track_script {
        chk_apache
    }

    virtual_ipaddress {
        10.0.0.155/24
    }
}
Reiniciar Keepalived:

bash
Copiar código
sudo systemctl restart keepalived
sudo systemctl status keepalived
5. Pruebas de Alta Disponibilidad del servicio HTTP
Desde un navegador, acceder a:

text
Copiar código
http://10.0.0.155
Deberías ver:

Si el MASTER está activo:
"Servicio Web Activo en Server 1 (MASTER)"

Si el BACKUP toma el control:
"Servicio Web Activo en Server 2 (BACKUP)"

Para probar el failover:

En kali1 (MASTER), apagar Apache:

bash
Copiar código
sudo systemctl stop apache2
Keepalived detectará que Apache está caído (por el script chk_apache) y el BACKUP (kali2) tomará la IP flotante 10.0.0.155.

Volver a cargar la página en el navegador: ahora debería mostrar el mensaje del Server 2 (BACKUP).

Para restaurar el estado original:

bash
Copiar código
sudo systemctl start apache2         # en kali1
sudo systemctl restart keepalived    # si es necesario
